name: Push via PR example
# WARN : need write main protection rule

# repository settings requirement : Allow GitHub Actions to create and approve pull requests
permissions:
  contents: write
  pull-requests: write

# this workflow is triggered from UI
on:
  workflow_dispatch:

jobs:
  handle-dispatch:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        # See supported Node.js release schedule at https://nodejs.org/en/about/releases/
        node-version: [ 20.x ]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run create some diff
        run: |
          date > my_new_date.txt
          echo "BRANCH_NAME=update-version-${{ github.sha }}" >> $GITHUB_ENV
          echo "VERSION=0.0.1-fake" >> $GITHUB_ENV
#
#      - name: Create a pull request
#        uses: peter-evans/create-pull-request@v7
#        with:
#          # base: main
#          branch: ${{ env.BRANCH_NAME}}
#          commit-message: Add version ${{ env.VERSION }}
#          title: Automated version update to ${{ env.VERSION }}
#          body: This PR updates the version file automatically. Generated from `push_via_PR_example.yml`.
#          author: ChickArmy[bot] <github-actions[bot].chickarmy@users.noreply.github.com>

      - name: Create Pull Request
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'Automated version update to ${{ env.VERSION }}';
            const body = 'This PR updates the version file automatically. Generated from `push_via_PR_example.yml`.';
            const headBranch = '${{ env.BRANCH_NAME}}';
            const baseBranch = 'main';

            const response = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              head: headBranch,
              base: baseBranch,
            });

            console.log(`Pull request créée: #${response.data.number}`);

      - name: Find Pull Request
        id: find_pr
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ env.BRANCH_NAME }}';
            console.log(`Searching for pull request for branch: ${branchName}`);
            console.log(`Owner: ${context.repo.owner}, Repo: ${context.repo.repo}`);
            console.log(context)
            
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
            });

            const pr = prs.data.find(pr => pr.head.ref === branchName);
            if (pr) {
              console.log(`Found pull request: #${pr.number} - ${pr.title}`);
              return pr.number;
            } else {
              console.log('No pull request found for this branch.');
              return null;
            }

#     - name: Merge Pull Request
#       if: ${{ steps.find_pr.outputs.result != '' }}
#       uses: actions/github-script@v7
#       with:
#         script: |
#           const prNumber = ${{ steps.find_pr.outputs.result }};
#           console.log(`Merging pull request: #${prNumber}`);
#           await github.rest.pulls.merge({
#             owner: context.repo.owner,
#             repo: context.repo.repo,
#             pull_number: prNumber,
#             merge_method: 'rebase', // ou 'squash' ou 'merge'
#           });
#           console.log(`Pull request #${prNumber} merged successfully.`);

      # BYPASS_USER_PAT - from team user (which is in repo bypass list) fine grained PAT with content+pullrequest write
      - name: Merge Pull Request with BYPASS_USER_PAT
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.find_pr.outputs.result }};
            console.log(`Merging pull request: #${prNumber}`);
            const githubWithPat = new github.GitHub(process.env.BYPASS_USER_PAT);
            await githubWithPat.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              merge_method: 'rebase',
            });
            console.log(`Pull request #${prNumber} merged successfully.`);
        env:
          BYPASS_USER_PAT: ${{ secrets.BYPASS_USER_PAT }}